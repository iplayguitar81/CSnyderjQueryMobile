



<!DOCTYPE html>


<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>

<title>checkenginefree.com demo</title>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<link rel="stylesheet" href="//code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.css">
<script src="//code.jquery.com/jquery-1.10.2.min.js"></script>
<script src="//code.jquery.com/mobile/1.4.3/jquery.mobile-1.4.3.min.js"></script>

<script>


    function onPositionReady() {
        alert("Your current Latitude,Longitude is:  "+ latitude+","+longitude);
        //initialize();


        $("#loading_animation").hide();
        map.setCenter(new google.maps.LatLng(latitude,longitude));
        // proceed
    }
</script>

<style type="text/css">
    #wrappa { width: 97%;

    }
    #map_canvas {
        width:   80%;
        height:  300px;
        margin-bottom: 2%;
        margin-left: 10%;
        padding: 0;
        float:left;

    }
    .infowindow * {font-size: 90%; margin: 0}
</style>
<!--Load the AJAX API-->
<script type="text/javascript" src="http://www.google.com/jsapi"></script>
<script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false&amp;v=3"></script>
<script type="text/javascript" src="http://geoxml3.googlecode.com/svn/branches/polys/geoxml3.js"></script>

<!-- The Google Maps Javascript -->
<script type="text/javascript">
    // Fusion Table data ID
    var FT_TableID = "1PpSun_kqXlSElvgJeDBmbrcZT_Ra_sxM5fNncRj8"; //378969;




    google.load('visualization', '1', {'packages':['corechart', 'table', 'geomap']});

    function  createSidebar() {
        // https://www.google.com/fusiontables/api/query?sql=SELECT%20ROWID,%20%2A%20FROM%20564705

        //set the query using the parameter
        // var queryText = encodeURIComponent("http://www.google.com/fusiontables/gvizdata?tq=SELECT * FROM FT_TableID");
        // var query = new google.visualization.Query(queryText);


        navigator.geolocation.getCurrentPosition(function(position) {
            var lat= position.coords.latitude, lng= position.coords.longitude

            var queryText = encodeURIComponent("SELECT 'Location', 'Fcilty_nam' AS 'Store Name', 'Locality' AS 'Address/Phone', 'telephone','latitude-col','longitude-col' FROM "+FT_TableID +" ORDER BY ST_DISTANCE(Location, LATLNG("+lat+","+lng+")) LIMIT 5");
            var query = new google.visualization.Query('http://www.google.com/fusiontables/gvizdata?tq='  + queryText);
//SELECT 'Store Name', Hours, Address FROM 1tqv1e7y689555xxx5_eeee345ee_CvWxxxhg9gc ORDER BY ST_DISTANCE(Address, LATLNG(37.5242,-121.6806)) LIMIT 10

            //set the callback function
            query.send(getData);

        })

    }
    google.setOnLoadCallback(createSidebar);
    // Set a callback to run when the Google Visualization API is loaded.

</script>
<script type="text/javascript">

var FTresponse = null;
//define callback function, this is called when the results are returned
function getData(response) {
    if (!response) {
        alert('no response');
        return;
    }
    if (response.isError()) {
        alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
        return;
    }
    FTresponse = response;
    //for more information on the response object, see the documentation
    //http://code.google.com/apis/visualization/documentation/reference.html#QueryResponse
    numRows = response.getDataTable().getNumberOfRows();
    numCols = response.getDataTable().getNumberOfColumns();

    //concatenate the results into a string, you can build a table here
    //fusiontabledata = "<h3 class='nearest_locations'>Nearest 5 Locations* <br/><span class='small-caps'>*Based on your GPS "+ "<br/>Latitude: "+ latitude + "<br/> Longitude: "  +longitude + "</span></h3>";
//  for(i = 1; i < numCols; i++) {
//        fusiontabledata += "<th>" + response.getDataTable().getColumnLabel(i) + "</th>";
//   }
//        fusiontabledata += "</tr><tr>";
    var count_ula = 0;
    var count= 1;
    fusiontabledata="";
    for(var i = 0; i < numRows; i++) {

        if(count == 1) {
            fusiontabledata+="<div data-role='collapsible' data-collapsed='false'><h3>"+count+").  ";

        }
        else {
            fusiontabledata+="<div data-role='collapsible'><h3>"+count+").  ";

        }

        for(var j = 1; j < numCols; j++) {


            if(j <= 2 ) {


                if(j == 1) {
                    fusiontabledata += "<a class='plop_links' href='javascript:myFTclick("+i+")'>"+response.getDataTable().getValue(i, j) + "</a></h3><br/>";

                }
                else if (j == 2) {
                    fusiontabledata += "<p><a class='plop_links' href='javascript:myFTclick("+i+")'>"+response.getDataTable().getValue(i, j) + "</a></p>";

                }


            }

            else if (j == 3) {
                fusiontabledata += "<p><a data-icon='phone' data-iconpos='left' data-role='button' class='plop_links' href='tel:"+response.getDataTable().getValue(i, j)+"'> <span class='ui-button-text' >"+response.getDataTable().getValue(i, j) + "</a></li></ul></span></p></div>";
            }

            // <div data-role="navbar"><ul><li>

            else {

                if (j == 5) {

                    test_string ="hide_these"+count+"a"
                }
                else {
                    var test_string = "hide_these"+count

                }
                //where i can put the lat and long for each one in a div and hide it to do calcs on each address click
                fusiontabledata += "<div class='"+test_string+"'>"+response.getDataTable().getValue(i, j) + "<br/></div>";
            }

            //$("#sidebar").trigger("create");
        }

        fusiontabledata += "";
        count++;
        count_ula++;
    }

    fusiontabledata+="";

    //display the results on the page
    document.getElementById('sidebar').innerHTML = fusiontabledata;
    // document.getElementById('siding').innerHTML = fusiontabledata;

    $( "#sidebar").collapsible().enhanceWithin();
    //$( "#siding").collapsible().enhanceWithin();
}

//latlng, contact, contactAlt
function openInfoWindowGeocoded(address, name, focusArea){
    if (geocoder) {
        geocoder.geocode( { 'address': address}, function(results, status) {
            if (status == google.maps.GeocoderStatus.OK) {
                if (status != google.maps.GeocoderStatus.ZERO_RESULTS) {
                    map.setCenter(results[0].geometry.location);
                    openFtInfoWindow(results[0].geometry.location, name, focusArea, address);

                } else {
                    alert("No results found");
                }
            } else {
                alert("Geocode was not successful for the following reason: " + status);
            }
        });
    }
}

var content22;

function openFtInfoWindow(position, name, focusArea, contact) {
    // Set up and create the infowindow
    if (!infoWindow) infoWindow = new google.maps.InfoWindow({});
    var content = '<div class="FT_infowindow">' + name;
    if (focusArea)  content += '<br>'+focusArea;
    if (contact)    content += '<br>'+contact+'</a>';
    // if (contactAlt) content += '<br>'+contactAlt;
    // content += '<br>('+position.toUrlValue(4)+")";
    //if (extraContent) content += "<br>["+extraContent+"]";
    content += '<br>'+'<a href="javascript:map.setCenter(new google.maps.LatLng'+position+');map.setZoom(map.getZoom()+3);">zoom in</a>';
    console.log ( position );
    content += '<br/></div>';
    content22=content;
    infoWindow.setOptions({
        content: content,
        pixelOffset: null,
        position: position
    });
    // Infowindow-opening event handler
    infoWindow.open(map);
}




function myFTclick(row) {
    // var name = FTresponse.getDataTable().getValue(row,0);
    var latlng =  FTresponse.getDataTable().getValue(row,0);
    //var focusArea = FTresponse.getDataTable().getValue(row,1);
    var contact = FTresponse.getDataTable().getValue(row,2);
    var contactAlt = FTresponse.getDataTable().getValue(row,1);

    if (latlng.indexOf("<") == -1) {
        var coords = latlng.split(',');
        var lat = parseFloat(coords[4]);
        var lng = parseFloat(coords[5]);
        if (isNaN(lat) || isNaN(lng)) {
            // assume address, send to geocoder
            openInfoWindowGeocoded(contact, contactAlt);
        }
        var position = new google.maps.LatLng(lat,lng);

        //flippin sweet
        map.setZoom(15);

        openFtInfoWindow(position, contactAlt,0);
    } else {

        var position = gpolygons[row].position;
        openFtInfoWindow(position, contactAlt,0);
    }
}

function addClickHandler(FTLayer) {
    google.maps.event.addListener(FTLayer, "click", function(event) {
        if (infoWindow) infoWindow.close();
        infoWindow.setOptions({pixelOffset:null,
            content: event.row['Fcilty_nam'].value+ "<br/>" + event.row['Locality'].value +"<br/>"+'<a href="javascript:map.setCenter(new google.maps.LatLng'+event.latLng+');map.setZoom(map.getZoom()+3);">zoom in</a><br/><br/>',
            position:event.latLng
        });
        infoWindow.open(map);
    });
}

//
var map = null;
var geocoder = null;
var infoWindow = null;
var zoom = 13;
var latlng = new google.maps.LatLng(0.00, -100.00);
//var query = "";
var info = null;
var gpolygons = [];
var geoXml = null;



//var map;
var infoWindow = new google.maps.InfoWindow();
var DEFAULT_ICON_URL = 'http://g.etfv.co/http://www.google.com'
//
//// EDIT: change this key to your own from the Google APIs Console
//// https://code.google.com/apis/console/
var apiKey = 'AIzaSyCydvzLJsTURSY_t_qSgOqAECnLHB66bWg';
//
//// EDIT: Specify the table with location data and icon URLs
var tableID = '1PpSun_kqXlSElvgJeDBmbrcZT_Ra_sxM5fNncRj8';
//
//// Create variables for the columns you need to retrieve from the table
//// EDIT this list as needed, then find and edit two places below.
var locality = 'Location';
var name = 'Fcilty_nam';
var address = 'Locality';
var latty = 'latitude-col';
var longy = 'longitude-col';
var phoney = 'telephone';
var iconUrlColumn = 'icon';

function createMarker (coordinate, url, content) {
    var marker = new google.maps.Marker({
        map: map,
        position: coordinate,
        icon: new google.maps.MarkerImage(url)
    });
    google.maps.event.addListener(marker, 'click', function(event) {
        infoWindow.setPosition(coordinate);
        infoWindow.setContent(content);
        infoWindow.open(map);
    });
};



//  locality + ','
//        + name + ','
//        + address + ','
//        + phoney + ','
//        + iconUrlColumn +


var latitude, longitude;
function initialize() {
//latlng
//zoom


    $(document).ready(function(){
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(handle_geolocation_query,handle_errors);
        } else {
            alert("Device probably not ready.");
        }
    });



    fetchData();  // begin retrieving data from table, and put it on the map
//var center_this = new google.maps.LatLng(latitude,longitude);
    map = new google.maps.Map(document.getElementById('map_canvas'), {
        center: latlng,
        zoom: zoom,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    });



}

function handle_errors(error) {
    // error handling here
}
function handle_geolocation_query(position){
    latitude = (position.coords.latitude);
    longitude = (position.coords.longitude);
    onPositionReady();
}


function fetchData() {

    // Construct a query to get data from the Fusion Table
    // EDIT this list to include the variables for columns named above
    var query = 'SELECT '
            + locality + ','
            + name + ','
            + address + ','
            + latty + ','
            + longy + ','
            + phoney + ','
            + iconUrlColumn +

            ' FROM '
            + tableID;
    var encodedQuery = encodeURIComponent(query);

    // Construct the URL
    var url = ['https://www.googleapis.com/fusiontables/v1/query'];
    url.push('?sql=' + encodedQuery);
    url.push('&key=' + apiKey);
    url.push('&callback=?');

    // Send the JSONP request using jQuery
    $.ajax({
        url: url.join(''),
        dataType: 'jsonp',
        success: onDataFetched
    });
}


function onDataFetched(data) {
    var rows = data['rows'];
    var iconUrl;
    var content;
    var coordinate;

    // Copy each row of data from the response into variables.
    // Each column is present in the order listed in the query.
    // Starting from 0.
    // EDIT this if you've changed the columns, above.
    for (var i in rows) {
        coordinate = new google.maps.LatLng(rows[i][4],rows[i][3]);
        iconUrl = rows[i][6];
        content = rows[i][1]  + "<br/>" + rows[i][2] + "<br/>" + rows[i][5] ;


        if (iconUrl) {   // ensure not empty
            createMarker(coordinate, iconUrl, content);

        } else {
            createMarker(coordinate, DEFAULT_ICON_URL, content);
        }
    }
}


</script>

<link rel="stylesheet" type="text/css" href="storelocator.css">
</head>
<body>


<div data-role="page" id="mappins">

    <div data-role="header" style="overflow:hidden;" data-position="fixed">

        <img class='img-responsive' alt='checkenginefree.com' src='checkenginelogoyay.png'/>


        <div data-role="navbar">
            <ul class="nav-trickery">
                <li><a href="#mappins" class="ui-state-persist" data-icon="navigation">Map</a></li>


                <li><a href="#about" data-icon="info">About</a></li>
                <li><a href="#contact" data-icon="mail">Contact</a></li>
            </ul>
        </div><!-- /navbar -->
    </div>


    <div id="wrappa">


        <div id="loading_animation"><img src="loader.gif" alt="loading location"/></div>


        <div id="map_canvas"></div>


        <br/>
        <br/>
    </div>

    <div id="sidebar" data-role="collapsible">

    </div>




    <div data-role="footer" style="overflow:hidden;" data-position="fixed">

        <span class="credit">checkenginefree.com &copy; 2014</span>
    </div><!-- /footer -->


</div>

<div data-role="page" id="about">

    <div data-role="header" style="overflow:hidden;" data-position="fixed">

        <img class='img-responsive' alt='checkenginefree.com' src='checkenginelogoyay.png'/>


        <div data-role="navbar">
            <ul class="nav-trickery">
                <li><a href="#mappins"  data-icon="navigation">Map</a></li>


                <li><a href="#about" class="ui-state-persist" data-icon="info">About</a></li>
                <li><a href="#contact" data-icon="mail">Contact</a></li>
            </ul>
        </div><!-- /navbar -->
    </div>


    <div id="wrappa2">

        This will be the about us page.....
    </div>


    <div data-role="footer" style="overflow:hidden;" data-position="fixed">

        <span class="credit">checkenginefree.com &copy; 2014</span>
    </div><!-- /footer -->
</div>


<div data-role="page" id="contact">

    <div data-role="header" style="overflow:hidden;" data-position="fixed">

        <img class='img-responsive' alt='checkenginefree.com' src='checkenginelogoyay.png'/>


        <div data-role="navbar">
            <ul class="nav-trickery">
                <li><a href="#mappins"  data-icon="navigation">Map</a></li>
                <li><a href="#about" data-icon="info">About</a></li>
                <li><a href="#contact" class="ui-state-persist" data-icon="mail">Contact</a></li>
            </ul>
        </div><!-- /navbar -->
    </div>


    <div id="wrappa3">

        This will be the contact us page.....
    </div>


    <div data-role="footer" style="overflow:hidden;" data-position="fixed">

        <span class="credit">checkenginefree.com &copy; 2014</span>
    </div><!-- /footer -->

</div>

<script>

    google.maps.event.addDomListener(window, "load", initialize());


</script>
</body>
</html>






