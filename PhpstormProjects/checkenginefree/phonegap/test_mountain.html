
<!DOCTYPE html>
<html>
<head>
    <title>Google Maps API v3 Example: Distance Matrix</title>
    <script src="https://maps.googleapis.com/maps/api/js?v=3&sensor=false"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
    <script type="text/javascript" src="http://geoxml3.googlecode.com/svn/branches/polys/geoxml3.js"></script>
    <style>
        body {
            margin: 20px;
            font-family: courier, sans-serif;
            font-size: 12px;
        }
        #map {
            height: 480px;
            width: 640px;
            border: solid thin #333;
            margin-top: 20px;
        }
    </style>

    <script type="text/javascript">

        if (google && google.load) google.load('visualization', '1', {'packages':['corechart', 'table', 'geomap']});
        else alert("google.load not available");

        var origin = new google.maps.LatLng(55.930385, -3.118425);
        var destinations = [];
        var marker = null;
        var service = new google.maps.DistanceMatrixService();
        var FT_TableID = "1hFcGeKfBgELMvxajsoMvgabWJX9jwNDKUB4HoAxG";

        var map;
        var geocoder;
        var bounds = new google.maps.LatLngBounds();
        var markersArray = [];

        var base = new google.maps.LatLng(55.930385, -3.118425);
        var start = 'Greenwich, England';
        var destinationA = 'Stockholm, Sweden';
        var end = new google.maps.LatLng(50.087692, 14.421150);

        var destinationIcon = 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=D|FF0000|000000';
        var originIcon = 'https://chart.googleapis.com/chart?chst=d_map_pin_letter&chld=O|FFFF00|000000';

        function initialize() {
            var opts = {
                center: new google.maps.LatLng(55.53, 9.4),
                zoom: 10,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            map = new google.maps.Map(document.getElementById('map'), opts);
            var schools = new google.maps.FusionTablesLayer({
                query: {
                    select: 'geometry',
                    from: FT_TableID // '1mae334i-txYZFixePEiC7lgYYyi4w6qDN87XAyw'
                },
                map: map
            });
            geocoder = new google.maps.Geocoder();

            //set the query using the parameter
            var queryString ="SELECT 'Locality' FROM "+FT_TableID + " LIMIT 3";
            var queryText = encodeURIComponent(queryString);
            var query = new google.visualization.Query('http://www.google.com/fusiontables/gvizdata?tq='  + queryText);
            document.getElementById('FTquery').innerHTML = queryString;
//set the callback function
            query.send(createDestinations);

        }

        function createDestinations(response) {
            if (!response) {
                alert('no response');
                return;
            }
            if (response.isError()) {
                alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
                return;
            }
            FTresponse = response;
            //for more information on the response object, see the documentation
            //http://code.google.com/apis/visualization/documentation/reference.html#QueryResponse
            numRows = response.getDataTable().getNumberOfRows();
            numCols = response.getDataTable().getNumberOfColumns();
            var geoXml = new geoXML3.parser();
            var bounds = new google.maps.LatLngBounds();
            var request=0;
            destinations[0] = [];
            for (var i=0; ((i<numRows) && (i<3)); i++) {
                var kml = FTresponse.getDataTable().getValue(i,0);
                geoXml.parseKmlString("<Placemark>"+kml+"</Placemark>");
                destinations[request].push(geoXml.docs[i].markers[0].getPosition());
                bounds.extend(geoXml.docs[i].markers[0].getPosition());
            }
            map.fitBounds(bounds);
            calculateDistances(0);
        }

        function calculateDistances(request) {
            service.getDistanceMatrix({
                origins: [origin],
                destinations: destinations[request],
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.IMPERIAL,
                avoidHighways: false,
                avoidTolls: false
            }, function (response, status) {
                if (status != google.maps.DistanceMatrixStatus.OK) {
                    alert('Error was: ' + status);
                } else {
                    var origins = response.originAddresses;
                    var destinationAdds = response.destinationAddresses;
                    htmlString = '<table border="1">';
                    deleteOverlays();
                    for (var i = 0; i < origins.length; i++) {
                        var results = response.rows[i].elements;
                        for (var j = 0; j < results.length; j++) {
                            htmlString += '<tr><td>'+destinationAdds[j]+'</td><td>' + results[j].distance.text +'</td></tr>';
                        }
                    }
                }
                var outputDiv = document.getElementById('outputDiv');
                htmlString += '</table>';
                outputDiv.innerHTML = htmlString;
            });
        }

        function addMarker(location, isDestination) {
            var icon;
            if (isDestination) {
                icon = destinationIcon;
            } else {
                icon = originIcon;
            }
            geocoder.geocode({'address': location}, function(results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    bounds.extend(results[0].geometry.location);
                    map.fitBounds(bounds);
                    var marker = new google.maps.Marker({
                        map: map,
                        position: results[0].geometry.location,
                        icon: icon
                    });
                    markersArray.push(marker);
                } else {
                    alert('Geocode was not successful for the following reason: '
                    + status);
                }
            });
        }

        function deleteOverlays() {
            if (markersArray) {
                for (i in markersArray) {
                    markersArray[i].setMap(null);
                }
                markersArray.length = 0;
            }
        }

        function codeAddress() {
            var address = document.getElementById("address").value;
            geocoder.geocode( { 'address': address}, function(results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    map.setCenter(results[0].geometry.location);
                    var lat = results[0].geometry.location.lat();
                    var lng = results[0].geometry.location.lng();

                    if (marker) marker.setMap(null);

                    marker = new google.maps.Marker({
                        map: map,
                        position: results[0].geometry.location
                    });
                    origin = results[0].geometry.location;
                    calculateDistances(0);
                } else {
                    alert("Geocode was not successful for the following reason: " + status);
                }
            });
        }
    </script>
</head>
<body onload="initialize()">
<div>
    <input id="address" type="textbox" value="Saltzburg, Austria">
    <input type="button" value="Geocode" onclick="codeAddress()">
</div>
<table border="1"><tr><td valign="top">
    <div id="map"></div>
</td><td>
    <div id="outputDiv"></div>
</td></tr></table>
<div id="FTquery"></div>
<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
    _uacct = "UA-162157-1";
    urchinTracker();
</script>
</body>
</html>
