
<!DOCTYPE html>

<!--
  copyright (c) 2011 Google inc.

  You are free to copy and use this sample.
  License can be found here: http://code.google.com/apis/ajaxsearch/faq/#license
-->

<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>

<title>Watershed Stewards Map</title>

<style type="text/css">
    html, body, #map_canvas {
        width:   700px;
        height:  600px;
        margin:  0;
        padding: 0;
    }
    .infowindow * {font-size: 90%; margin: 0}
</style>
<!--Load the AJAX API-->
<script type="text/javascript" src="http://www.google.com/jsapi"></script>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script type="text/javascript" src="http://geoxml3.googlecode.com/svn/branches/polys/geoxml3.js"></script>

<!-- The Google Maps Javascript -->
<script type="text/javascript">
    // Fusion Table data ID
    var FT_TableID = 648894; //378969;


    google.load('visualization', '1', {'packages':['corechart', 'table', 'geomap']});

    function  createSidebar() {
        // https://www.google.com/fusiontables/api/query?sql=SELECT%20ROWID,%20%2A%20FROM%20564705

        //set the query using the parameter
        // var queryText = encodeURIComponent("http://www.google.com/fusiontables/gvizdata?tq=SELECT * FROM FT_TableID");
        // var query = new google.visualization.Query(queryText);
        var queryText = encodeURIComponent("SELECT 'Name', 'Lat', 'Focus Area', 'Contact', 'Contact alt' FROM "+FT_TableID);
        var query = new google.visualization.Query('http://www.google.com/fusiontables/gvizdata?tq='  + queryText);


        //set the callback function
        query.send(getData);

    }

    // Set a callback to run when the Google Visualization API is loaded.
    google.setOnLoadCallback(createSidebar);
</script>
<script type="text/javascript">

    var FTresponse = null;
    //define callback function, this is called when the results are returned
    function getData(response) {
        if (!response) {
            alert('no response');
            return;
        }
        if (response.isError()) {
            alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
            return;
        }
        FTresponse = response;
        //for more information on the response object, see the documentation
        //http://code.google.com/apis/visualization/documentation/reference.html#QueryResponse
        numRows = response.getDataTable().getNumberOfRows();
        numCols = response.getDataTable().getNumberOfColumns();

        //concatenate the results into a string, you can build a table here
        fusiontabledata = "<table><tr>";
//  for(i = 0; i < numCols; i++) {
        fusiontabledata += "<th>" + response.getDataTable().getColumnLabel(0) + "</th>";
//   }
        fusiontabledata += "</tr><tr>";

        for(i = 0; i < numRows; i++) {
//    for(j = 0; j < numCols; j++) {
            fusiontabledata += "<td><a href='javascript:myFTclick("+i+")'>"+response.getDataTable().getValue(i, 0) + "</a></td>";
//    }
            fusiontabledata += "</tr><tr>";
        }
        fusiontabledata += "</table>"
        //display the results on the page
        document.getElementById('sidebar').innerHTML = fusiontabledata;
    }

    function openInfoWindowGeocoded(address, name, focusArea, contact, contactAlt){
        if (geocoder) {
            geocoder.geocode( { 'address': address}, function(results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    if (status != google.maps.GeocoderStatus.ZERO_RESULTS) {
                        map.setCenter(results[0].geometry.location);
                        openFtInfoWindow(results[0].geometry.location, name, focusArea, contact, contactAlt, address);

                    } else {
                        alert("No results found");
                    }
                } else {
                    alert("Geocode was not successful for the following reason: " + status);
                }
            });
        }
    }


    function openFtInfoWindow(position, name, focusArea, contact, contactAlt, extraContent) {
        // Set up and create the infowindow
        if (!infoWindow) infoWindow = new google.maps.InfoWindow({});
        var content = '<div class="FT_infowindow">' + name;
        if (focusArea)  content += '<br>'+focusArea;
        if (contact)    content += '<br><a href="'+contact+'">'+contact+'</a>';
        if (contactAlt) content += '<br>'+contactAlt;
        content += '<br>('+position.toUrlValue(4)+")";
        if (extraContent) content += "<br>["+extraContent+"]";
        content += '<br>'+'<a href="javascript:map.setCenter(new google.maps.LatLng'+position+');map.setZoom(map.getZoom()+1);">zoom in</a>';
        content += '</div>';
        infoWindow.setOptions({
            content: content,
            pixelOffset: null,
            position: position
        });
        // Infowindow-opening event handler
        infoWindow.open(map);
    }

    function parseKml(row) {
        if (!gpolygons[row]) {
            var name = FTresponse.getDataTable().getValue(row,0);
            var kml =  FTresponse.getDataTable().getValue(row,1);
            // create a geoXml3 parser for the click handlers
            var geoXml = new geoXML3.parser({
                map: map,
                zoom: false,
                infoWindow: infoWindow,
                singleInfoWindow: true
            });

            geoXml.parseKmlString("<Placemark>"+kml+"</Placemark>");
            gpolygons[row] = new Object();
            if (geoXml.docs[0].placemarks[0].Polygon) {
                geoXml.docs[0].gpolygons[0].setMap(null);
                gpolygons[row].position = geoXml.docs[0].gpolygons[0].bounds.getCenter();
                gpolygons[row].bounds = geoXml.docs[0].gpolygons[0].bounds;
            } else if (geoXml.docs[0].placemarks[0].LineString) {
                geoXml.docs[0].gpolylines[0].setMap(null);

                gpolygons[row].position = geoXml.docs[0].gpolylines[0].bounds.getCenter();
                gpolygons[row].bounds = geoXml.docs[0].gpolylines[0].bounds;
            }
            gpolygons[row].name = name;
        }
    }


    function myFTclick(row) {
        var name = FTresponse.getDataTable().getValue(row,0);
        var focusArea = FTresponse.getDataTable().getValue(row,2);
        var contact = FTresponse.getDataTable().getValue(row,3);
        var contactAlt = FTresponse.getDataTable().getValue(row,4);
        var latlng =  FTresponse.getDataTable().getValue(row,1);
        if (latlng.indexOf("<") == -1) {
            var coords = latlng.split(',');
            var lat = parseFloat(coords[0]);
            var lng = parseFloat(coords[1]);
            if (isNaN(lat) || isNaN(lng)) {
                // assume address, send to geocoder
                openInfoWindowGeocoded(latlng, name, focusArea, contact, contactAlt);
            }
            var position = new google.maps.LatLng(lat,lng);
            openFtInfoWindow(position, name, focusArea, contact, contactAlt);
        } else {
            parseKml(row)
            var position = gpolygons[row].position;
            openFtInfoWindow(position, name, focusArea, contact, contactAlt);
        }
    }

    function addClickHandler(FTLayer) {
        google.maps.event.addListener(FTLayer, "click", function(event) {
            if (infoWindow) infoWindow.close();
            infoWindow.setOptions({pixelOffset:null,
                content:event.infoWindowHtml,
                position:event.latLng
            });
            infoWindow.open(map);
        });
    }

    var map = null;
    var geocoder = null;
    var infoWindow = null;
    var zoom = 8;
    var latlng = new google.maps.LatLng(39.20, -77.90);
    var query = "";
    var info = null;
    var gpolygons = [];
    var geoXml = null;

    var image = new google.maps.MarkerImage('http://labs.google.com/ridefinder/images/mm_20_red.png');
    function initialize() {

        map = new google.maps.Map(document.getElementById('map_canvas'), {
            center: latlng,
            zoom: zoom,
            icon:'http://maps.google.com/mapfiles/kml/pal3/icon52.png',
            mapTypeId: google.maps.MapTypeId.ROADMAP
        });

        //create polygon layer. These have '<' in the data
        layer2 = new google.maps.FusionTablesLayer(FT_TableID, {suppressInfoWindows:true});
        layer2.setQuery("SELECT Lat FROM " + FT_TableID + " WHERE Lat CONTAINS '<'");
        layer2.setMap(map);
        addClickHandler(layer2);

        //now create a layer of just the markers, this data does not have '<'
        layer1 = new google.maps.FusionTablesLayer(FT_TableID, {suppressInfoWindows:true});
        layer1.setQuery("SELECT Lat FROM " + FT_TableID + " WHERE Lat DOES NOT CONTAIN '<'");
        layer1.setMap(map);
        addClickHandler(layer1);

        infoWindow = new google.maps.InfoWindow();
        geocoder = new google.maps.Geocoder();

    }

</script>
</head>
<body onload="initialize();">
<a href="http://www.google.com/fusiontables/DataSource?dsrcid=648894">Fusion Table</a>
<table style="width:100%;"><tr><td>
    <div id="map_canvas"></div>
</td><td>
    <div id="sidebar" style="width:320px;height:600px; overflow:auto"></div>
</td></tr>
</table>
<script src="http://www.google-analytics.com/urchin.js" type="text/javascript">
</script>
<script type="text/javascript">
    _uacct = "UA-162157-1";
    urchinTracker();
</script>
</body>
</html>

