
<!DOCTYPE html>


<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>

<title>checkenginefree.com demo</title>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>

<script>

    var latitude, longitude;
    $(document).ready(function(){
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(handle_geolocation_query,handle_errors);
        } else {
            alert("Device probably not ready.");
        }
    });
    function handle_errors(error) {
        // error handling here
    }
    function handle_geolocation_query(position){
        latitude = (position.coords.latitude);
        longitude = (position.coords.longitude);
        onPositionReady();
    }
    function onPositionReady() {
        alert("Your current Latitude,Longitude is:  "+ latitude+","+longitude);
        initialize();
        map.setCenter(new google.maps.LatLng(latitude, longitude));

        $("#loading_animation").hide();
        // proceed
    }
</script>
<link rel="stylesheet" type="text/css" href="storelocator.css">
<style type="text/css">
    #wrappa { width: 97%;

    }
    #map_canvas {
        width:   45%;
        height:  300px;
        margin:  0;
        padding: 0;
        float:left;
    }
    .infowindow * {font-size: 90%; margin: 0}
</style>
<!--Load the AJAX API-->
<script type="text/javascript" src="http://www.google.com/jsapi"></script>
<script type="text/javascript" src="https://maps.google.com/maps/api/js?sensor=false&amp;v=3"></script>
<script type="text/javascript" src="http://geoxml3.googlecode.com/svn/branches/polys/geoxml3.js"></script>

<!-- The Google Maps Javascript -->
<script type="text/javascript">
    // Fusion Table data ID
    var FT_TableID = "1h_dxq_8XtHVeAzcms8NGuk3-ycarToxVzHz2e49L"; //378969;




    google.load('visualization', '1', {'packages':['corechart', 'table', 'geomap']});

    function  createSidebar() {
        // https://www.google.com/fusiontables/api/query?sql=SELECT%20ROWID,%20%2A%20FROM%20564705

        //set the query using the parameter
        // var queryText = encodeURIComponent("http://www.google.com/fusiontables/gvizdata?tq=SELECT * FROM FT_TableID");
        // var query = new google.visualization.Query(queryText);


        navigator.geolocation.getCurrentPosition(function(position) {
            var lat= position.coords.latitude, lng= position.coords.longitude

            var queryText = encodeURIComponent("SELECT 'Location', 'Fcilty_nam' AS 'Store Name', 'Locality' AS 'Address/Phone' FROM "+FT_TableID +" ORDER BY ST_DISTANCE(Location, LATLNG("+lat+","+lng+")) LIMIT 5");
            var query = new google.visualization.Query('http://www.google.com/fusiontables/gvizdata?tq='  + queryText);
//SELECT 'Store Name', Hours, Address FROM 1tqv1e7y689555xxx5_eeee345ee_CvWxxxhg9gc ORDER BY ST_DISTANCE(Address, LATLNG(37.5242,-121.6806)) LIMIT 10

            //set the callback function
            query.send(getData);

        })

    }
    google.setOnLoadCallback(createSidebar);
    // Set a callback to run when the Google Visualization API is loaded.

</script>
<script type="text/javascript">

    var FTresponse = null;
    //define callback function, this is called when the results are returned
    function getData(response) {
        if (!response) {
            alert('no response');
            return;
        }
        if (response.isError()) {
            alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
            return;
        }
        FTresponse = response;
        //for more information on the response object, see the documentation
        //http://code.google.com/apis/visualization/documentation/reference.html#QueryResponse
        numRows = response.getDataTable().getNumberOfRows();
        numCols = response.getDataTable().getNumberOfColumns();

        //concatenate the results into a string, you can build a table here
        fusiontabledata = "<h3 class='nearest_locations'>Nearest 5 Locations* <br/><span class='small-caps'>*Based on your GPS "+ "<br/>Latitude: "+ latitude + "<br/> Longitude: "  +longitude + "</span></h3><table><tr>";
        for(i = 1; i < numCols; i++) {
            fusiontabledata += "<th>" + response.getDataTable().getColumnLabel(i) + "</th>";
        }
        fusiontabledata += "</tr><tr>";

        for(i = 0; i < numRows; i++) {
            for(j = 1; j < numCols; j++) {
                fusiontabledata += "<td><a href='javascript:myFTclick("+i+")'>"+response.getDataTable().getValue(i, j) + "</a></td>";
            }

            fusiontabledata += "</tr><tr>";

        }
        fusiontabledata += "</table>"
        //display the results on the page
        document.getElementById('sidebar').innerHTML = fusiontabledata;
    }

    //latlng, contact, contactAlt
    function openInfoWindowGeocoded(address, name, focusArea){
        if (geocoder) {
            geocoder.geocode( { 'address': address}, function(results, status) {
                if (status == google.maps.GeocoderStatus.OK) {
                    if (status != google.maps.GeocoderStatus.ZERO_RESULTS) {
                        map.setCenter(results[0].geometry.location);
                        openFtInfoWindow(results[0].geometry.location, name, focusArea, address);

                    } else {
                        alert("No results found");
                    }
                } else {
                    alert("Geocode was not successful for the following reason: " + status);
                }
            });
        }
    }

    var content22;

    function openFtInfoWindow(position, name, focusArea, contact) {
        // Set up and create the infowindow
        if (!infoWindow) infoWindow = new google.maps.InfoWindow({});
        var content = '<div class="FT_infowindow">' + name;
        if (focusArea)  content += '<br>'+focusArea;
        if (contact)    content += '<br>'+contact+'</a>';
        // if (contactAlt) content += '<br>'+contactAlt;
        // content += '<br>('+position.toUrlValue(4)+")";
        //if (extraContent) content += "<br>["+extraContent+"]";
        content += '<br>'+'<a href="javascript:map.setCenter(new google.maps.LatLng'+position+');map.setZoom(map.getZoom()+1);">zoom in</a>';
        console.log ( position );
        content += '<br/></div>';
        content22=content;
        infoWindow.setOptions({
            content: content,
            pixelOffset: null,
            position: position
        });
        // Infowindow-opening event handler
        infoWindow.open(map);
    }




    function myFTclick(row) {
        // var name = FTresponse.getDataTable().getValue(row,0);
        var latlng =  FTresponse.getDataTable().getValue(row,0);
        //var focusArea = FTresponse.getDataTable().getValue(row,1);
        var contact = FTresponse.getDataTable().getValue(row,2);
        var contactAlt = FTresponse.getDataTable().getValue(row,1);

        if (latlng.indexOf("<") == -1) {
            var coords = latlng.split(',');
            var lat = parseFloat(coords[4]);
            var lng = parseFloat(coords[5]);
            if (isNaN(lat) || isNaN(lng)) {
                // assume address, send to geocoder
                openInfoWindowGeocoded(contact, contactAlt);
            }
            var position = new google.maps.LatLng(lat,lng);
            openFtInfoWindow(position, contactAlt,0);
        } else {

            var position = gpolygons[row].position;
            openFtInfoWindow(position, contactAlt,0);
        }
    }

    function addClickHandler(FTLayer) {
        google.maps.event.addListener(FTLayer, "click", function(event) {
            if (infoWindow) infoWindow.close();
            infoWindow.setOptions({pixelOffset:null,
                content: event.row['Fcilty_nam'].value+ "<br/>" + event.row['Locality'].value +"<br/>"+'<a href="javascript:map.setCenter(new google.maps.LatLng'+event.latLng+');map.setZoom(map.getZoom()+1);">zoom in</a><br/><br/>' ,
                position:event.latLng
            });
            infoWindow.open(map);
        });
    }


    var map = null;
    var geocoder = null;
    var infoWindow = null;
    var zoom = 12;
    var latlng = new google.maps.LatLng(0.00, -100.00);
    var query = "";
    var info = null;
    var gpolygons = [];
    var geoXml = null;


    function initialize() {

        map = new google.maps.Map(document.getElementById('map_canvas'), {
            center: latlng,
            zoom: zoom,
            icon: 'http://labs.google.com/ridefinder/images/mm_20_green.png',
            mapTypeId: google.maps.MapTypeId.ROADMAP

        });

//        //create polygon layer. These have '<' in the data
//        layer2 = new google.maps.FusionTablesLayer(FT_TableID, {suppressInfoWindows:true});
//        layer2.setQuery("SELECT Lat FROM " + FT_TableID + " WHERE Lat CONTAINS '<'");
//        layer2.setMap(map);
//        addClickHandler(layer2);

        //now create a layer of just the markers, this data does not have '<'
        layer1 = new google.maps.FusionTablesLayer(FT_TableID, {suppressInfoWindows:true} );

        layer1.setQuery("SELECT Location FROM " + FT_TableID);

        layer1.setMap(map);
        addClickHandler(layer1);

        infoWindow = new google.maps.InfoWindow();
        geocoder = new google.maps.Geocoder();

    }

    function onDataFetched(data) {
        var rows = data['rows'];
        var iconUrl;
        var content;
        var coordinate;

        // Copy each row of data from the response into variables.
        // Each column is present in the order listed in the query.
        // Starting from 0.
        // EDIT this if you've changed the columns, above.
        for (var i in rows) {
            coordinate = new google.maps.LatLng(rows[i][0],rows[i][1]);
            iconUrl = rows[i][2];
            content = rows[i][3];

            if (iconUrl) {   // ensure not empty
                createMarker(coordinate, iconUrl, content);
            } else {
                createMarker(coordinate, DEFAULT_ICON_URL, content);
            }
        }
    }


</script>
</head>
<body>
<div id="wrappa">
    <img class='img-responsive' alt='checkenginefree.com' src='checkenginelogoyay.png'/>

    <div id="loading_animation"><img src="loader.gif" alt="loading location"/></div>


    <div id="map_canvas"></div>

    <div id="sidebar" style="width:45%; height:300px;float:right;">


    </div>

</div>

</body>
</html>

